name: Promote Org Admin on JSON Change

on:
  workflow_dispatch:
  push:
    paths:
      - "org-admin/**/*.json"

jobs:
  promote-org-admin:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Check for Org Admin Request File
        id: check_request
        run: |
          # List all JSON files in the org-admin folder.
          files=$(find ./org-admin -type f -name "*.json")
          if [ -z "$files" ]; then
            echo "No request file found. Exiting."
            exit 0
          else
            echo "Found request files:"
            echo "$files"
            # For simplicity, take the first file found. You can modify this to iterate over multiple files.
            request_file=$(echo "$files" | head -n 1)
            echo "request_file=$request_file" >> $GITHUB_OUTPUT
          fi

      - name: Parse Request File
        id: parse_request
        run: |
          request_file="${{ steps.check_request.outputs.request_file }}"
          username=$(jq -r '.username' "$request_file")
          echo "username=$username" >> $GITHUB_OUTPUT

      - name: Create App token
        id: create_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.FSDH_TEAM_ADMIN_APP_ID }}
          private-key: ${{ secrets.FSDH_TEAM_ADMIN_APP_KEY }}
          owner: ${{ github.repository_owner }}
